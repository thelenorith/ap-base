# GitHub Workflows

Standard CI workflows for ap-* projects.

## Required Workflows

| Workflow | File | Trigger |
|----------|------|---------|
| Test | `test.yml` | push, PR |
| Lint | `lint.yml` | push, PR |
| Typecheck | `typecheck.yml` | push, PR |
| Format Check | `format.yml` | push, PR |
| Coverage | `coverage.yml` | push, PR |

## test.yml

```yaml
name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: make install-dev

      - name: Run tests
        run: make test
```

## lint.yml

```yaml
name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: make install-dev

      - name: Run linter
        run: make lint
```

## typecheck.yml

```yaml
name: Typecheck

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  typecheck:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: make install-dev

      - name: Run type checker
        run: make typecheck
```

## format.yml

```yaml
name: Format Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  format:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: make install-dev

      - name: Check code formatting
        run: |
          # Run format to see if any changes are needed
          make format

          # Check if any files were modified
          if ! git diff --exit-code; then
            echo "❌ Code formatting changes required!"
            echo "Please run 'make format' locally and commit the changes."
            echo ""
            echo "Files that need formatting:"
            git diff --name-only
            exit 1
          fi

          echo "✅ Code formatting is correct"
```

## coverage.yml

```yaml
name: Coverage Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: make install-dev

      - name: Generate coverage report
        run: |
          make coverage
          python -m coverage report | tail -1 | awk '{print $$4}' | sed 's/%//' > .coverage-percentage || echo "0" > .coverage-percentage

      - name: Extract coverage data and set badge info
        if: always()
        run: |
          COVERAGE=$(cat .coverage-percentage || echo "0")
          THRESHOLD=80
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
          echo "THRESHOLD=$THRESHOLD" >> $GITHUB_ENV

          if [ "$(echo "$COVERAGE" | cut -d. -f1)" -lt "$THRESHOLD" ]; then
            echo "COVERAGE_STATUS=failed" >> $GITHUB_ENV
            echo "BADGE_COLOR=red" >> $GITHUB_ENV
          else
            echo "COVERAGE_STATUS=passed" >> $GITHUB_ENV
            echo "BADGE_COLOR=green" >> $GITHUB_ENV
          fi

      - name: Comment on PR if coverage is below threshold
        if: always() && github.event_name == 'pull_request' && env.COVERAGE_STATUS == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = process.env.COVERAGE;
            const threshold = process.env.THRESHOLD;
            const badgeColor = process.env.BADGE_COLOR;

            const comment = `## ❌ Code Coverage Check FAILED

            ![Coverage Badge](https://img.shields.io/badge/coverage-${coverage}%25-${badgeColor})

            **Current Coverage:** ${coverage}%
            **Required Threshold:** ${threshold}%
            **Status:** Coverage is below the required threshold

            ⚠️ **This PR cannot be merged until coverage reaches at least ${threshold}%**

            ---
            *Coverage report generated by [coverage.py](https://coverage.readthedocs.io/)*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Verify coverage threshold (final pass/fail)
        run: |
          COVERAGE=$(cat .coverage-percentage || echo "0")
          THRESHOLD=80
          if [ "$(echo "$COVERAGE" | cut -d. -f1)" -lt "$THRESHOLD" ]; then
            echo "❌ Coverage check failed: ${COVERAGE}% is below the required ${THRESHOLD}% threshold"
            exit 1
          else
            echo "✅ Coverage check passed: ${COVERAGE}% meets the required ${THRESHOLD}% threshold"
          fi
```

## Conventions

### Python versions

Test on Python 3.10 through 3.14. Use 3.12 for single-version jobs (lint, format, coverage).

### Actions versions

Use current major versions:
- `actions/checkout@v4`
- `actions/setup-python@v5`

### Triggers

Run on push to main and all PRs to main:

```yaml
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
```

### Use Makefile targets

Workflows should call Makefile targets, not duplicate commands:

```yaml
- name: Run tests
  run: make test
```

### Git LFS

For projects with test fixtures tracked in Git LFS (e.g., FITS/XISF files), add `lfs: true` to the checkout step in test.yml:

```yaml
- uses: actions/checkout@v4
  with:
    lfs: true
```

This ensures fixture files are downloaded rather than just their LFS pointer files.
